name: Release and Publish

on:
    workflow_dispatch:
        inputs:
            version_type:
                description: 'The type of version bump (patch, minor, major)'
                required: true
                default: 'patch'
                type: choice
                options:
                    - patch
                    - minor
                    - major

jobs:
    publish:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  # We need to fetch all history and tags for versioning
                  fetch-depth: 0
                  # Use a PAT to allow pushing back to the repo
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1

            - name: Install dependencies
              run: bun install

            - name: Setup Git
              run: |
                  git config --global user.name "github-actions[bot]"
                  git config --global user.email "github-actions[bot]@users.noreply.github.com"

            - name: Lint and Build
              run: |
                  bun run lint
                  bun run build

            - name: Bump version
              id: version_bump
              run: |
                  # Using npm version to create commit and tag
                  NEW_TAG=$(npm version ${{ github.event.inputs.version_type }} -m "chore(release): bump version to %s")
                  echo "NEW_TAG=$NEW_TAG" >> $GITHUB_OUTPUT

            - name: Push changes
              run: git push origin main --follow-tags

            - name: Setup NPM
              run: |
                  echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc

            - name: Publish to npm
              run: npm publish
              env:
                  CI: true # Add CI environment variable
